name: Security Test Suite & Incident Response

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: -Xmx2048m

jobs:
  build:
    name: Build & Compile
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build with Maven
        run: mvn clean compile -B
      
      - name: Run OWASP Dependency Check
        run: mvn dependency-check:check -P security-scan
        continue-on-error: true
      
      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: target/dependency-check-report.html

  security-tests:
    name: Run Security Test Suite
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Start E-Commerce Application
        run: |
          cd ecommerce-app
          nohup mvn spring-boot:run > app.log 2>&1 &
          echo $! > app.pid
          sleep 40  # Wait for application to start
          # Verify app is running
          curl -f http://localhost:8080 || (cat app.log && exit 1)
        env:
          SPRING_PROFILES_ACTIVE: test
      
      - name: Run Security Tests
        run: |
          cd security-tests
          mvn test -Dheadless=true
        continue-on-error: true
      
      - name: Stop Application
        if: always()
        run: |
          if [ -f ecommerce-app/app.pid ]; then
            kill $(cat ecommerce-app/app.pid) || true
            sleep 5
          fi
          # Force kill any remaining Java processes
          pkill -f spring-boot:run || true
      
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-test-results
          path: |
            security-tests/target/surefire-reports/
            security-tests/test-output/
      
      - name: Upload Security Events Database
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-events-db
          path: ecommerce-app/data/security-events.*

  threat-analysis:
    name: Analyze Security Events & Detect Threats
    runs-on: ubuntu-latest
    needs: security-tests
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Python Dependencies
        run: |
          cd scripts/python
          pip install -r requirements.txt
      
      - name: Download Security Events Database
        uses: actions/download-artifact@v4
        with:
          name: security-events-db
          path: ecommerce-app/data/
      
      - name: Run Security Event Analyzer
        id: analyzer
        run: |
          cd scripts/python
          python security_analyzer.py
        continue-on-error: true
      
      - name: Upload Incident Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: incident-report
          path: scripts/python/security_incident_report_*.json
      
      - name: Create JIRA Tickets for Incidents
        if: always()
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
        run: |
          cd scripts/python
          REPORT_FILE=$(ls -t security_incident_report_*.json 2>/dev/null | head -1)
          if [ -n "$REPORT_FILE" ]; then
            python jira_ticket_generator.py "$REPORT_FILE"
          else
            echo "No incident report found to process"
          fi
        continue-on-error: true

  system-monitoring:
    name: System Security Monitoring (Windows)
    runs-on: windows-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Run PowerShell Security Monitor
        shell: pwsh
        run: |
          .\scripts\powershell\SecurityMonitor.ps1 -Verbose
        continue-on-error: true
      
      - name: Upload Monitoring Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: system-monitoring-report
          path: reports/security_monitoring_report.json

  vulnerability-scan:
    name: Run Fortify Security Scan
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      # Note: Fortify requires license - this is a placeholder
      - name: Run Fortify SCA
        run: |
          echo "Fortify SCA would run here with proper license"
          # mvn clean compile -P fortify
        continue-on-error: true

  generate-report:
    name: Generate Consolidated Security Report
    runs-on: ubuntu-latest
    needs: [security-tests, threat-analysis, system-monitoring]
    if: always()
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate Consolidated Report
        run: |
          mkdir -p final-report
          
          echo "# Security Test & Monitoring Report" > final-report/REPORT.md
          echo "Generated: $(date)" >> final-report/REPORT.md
          echo "" >> final-report/REPORT.md
          
          echo "## Test Execution Summary" >> final-report/REPORT.md
          if [ -f security-test-results/testng-results.xml ]; then
            echo "- Security tests executed successfully" >> final-report/REPORT.md
          fi
          
          echo "" >> final-report/REPORT.md
          echo "## Detected Incidents" >> final-report/REPORT.md
          if [ -f incident-report/security_incident_report_*.json ]; then
            INCIDENT_FILE=$(ls incident-report/security_incident_report_*.json | head -1)
            python3 -c "import json; data = json.load(open('$INCIDENT_FILE')); print(f\"- Total Incidents: {data['total_incidents']}\"); print(f\"- High Severity: {data['high_severity_count']}\"); print(f\"- Medium Severity: {data['medium_severity_count']}\")" >> final-report/REPORT.md
          fi
          
          echo "" >> final-report/REPORT.md
          echo "## Artifacts" >> final-report/REPORT.md
          echo "- Test Results: security-test-results/" >> final-report/REPORT.md
          echo "- Incident Reports: incident-report/" >> final-report/REPORT.md
          echo "- System Monitoring: system-monitoring-report/" >> final-report/REPORT.md
      
      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: final-security-report
          path: final-report/
      
      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('final-report/REPORT.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
      
      - name: Fail if High-Severity Incidents Found
        run: |
          if [ -f incident-report/security_incident_report_*.json ]; then
            INCIDENT_FILE=$(ls incident-report/security_incident_report_*.json | head -1)
            HIGH_COUNT=$(python3 -c "import json; data = json.load(open('$INCIDENT_FILE')); print(data['high_severity_count'])")
            if [ "$HIGH_COUNT" -gt 0 ]; then
              echo "❌ Found $HIGH_COUNT high-severity security incidents!"
              exit 1
            fi
          fi

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [generate-report]
    if: always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    
    steps:
      - name: Notification Placeholder
        run: |
          echo "✅ Security test suite completed"
          echo "Add email notifications by setting EMAIL_USERNAME and EMAIL_PASSWORD secrets"
          echo "View full report at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
