package com.security.tests.business;

import com.security.tests.base.BaseTest;
import com.security.tests.utils.SecurityEvent;
import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.testng.Assert;
import org.testng.annotations.Test;

/**
 * Tests for coupon exploitation and promotional code abuse.
 */
public class CouponExploitationTest extends BaseTest {
    
    @Test(priority = 1, description = "Test multiple coupon application")
    public void testMultipleCouponStacking() {
        navigateToUrl("/products");
        driver.findElement(By.className("add-to-cart")).click();
        navigateToUrl("/cart");
        
        String[] coupons = {"SAVE10", "FIRST20", "WELCOME15", "SPECIAL25"};
        int appliedCoupons = 0;
        
        for (String coupon : coupons) {
            driver.findElement(By.id("couponCode")).clear();
            driver.findElement(By.id("couponCode")).sendKeys(coupon);
            driver.findElement(By.id("applyCoupon")).click();
            
            if (driver.getPageSource().contains("Coupon applied") ||
                driver.getPageSource().contains("Discount applied")) {
                appliedCoupons++;
            }
        }
        
        // Should only allow one coupon
        Assert.assertTrue(appliedCoupons <= 1, 
            "System should prevent stacking multiple coupons - found " + appliedCoupons + " applied");
        
        if (appliedCoupons > 1) {
            SecurityEvent event = SecurityEvent.createHighSeverityEvent(
                "COUPON_STACKING_VULNERABILITY",
                "testuser",
                "Multiple coupon exploitation",
                "Successfully applied " + appliedCoupons + " coupons simultaneously"
            );
            eventLogger.logSecurityEvent(event);
        }
    }
    
    @Test(priority = 2, description = "Test expired coupon usage")
    public void testExpiredCouponUsage() {
        navigateToUrl("/cart");
        
        String expiredCoupon = "EXPIRED2023";
        driver.findElement(By.id("couponCode")).sendKeys(expiredCoupon);
        driver.findElement(By.id("applyCoupon")).click();
        
        boolean isRejected = driver.getPageSource().contains("expired") ||
                            driver.getPageSource().contains("Invalid coupon");
        
        Assert.assertTrue(isRejected, "Expired coupons should be rejected");
        
        if (!isRejected) {
            SecurityEvent event = SecurityEvent.createMediumSeverityEvent(
                "EXPIRED_COUPON_ACCEPTED",
                "testuser",
                "Expired coupon usage",
                "Expired coupon code accepted: " + expiredCoupon
            );
            eventLogger.logSecurityEvent(event);
        }
    }
    
    @Test(priority = 3, description = "Test coupon reuse after removal")
    public void testCouponReuse() {
        navigateToUrl("/cart");
        
        String coupon = "SAVE10";
        
        // Apply coupon
        driver.findElement(By.id("couponCode")).sendKeys(coupon);
        driver.findElement(By.id("applyCoupon")).click();
        
        // Remove coupon
        try {
            driver.findElement(By.id("removeCoupon")).click();
        } catch (Exception e) {
            // Remove button might not exist
        }
        
        // Try to reapply same coupon
        driver.findElement(By.id("couponCode")).clear();
        driver.findElement(By.id("couponCode")).sendKeys(coupon);
        driver.findElement(By.id("applyCoupon")).click();
        
        // Log the reuse attempt
        SecurityEvent event = SecurityEvent.createMediumSeverityEvent(
            "COUPON_REUSE_ATTEMPT",
            "testuser",
            "Coupon reapplication",
            "Attempted to reuse coupon: " + coupon
        );
        eventLogger.logSecurityEvent(event);
    }
    
    @Test(priority = 4, description = "Test discount percentage manipulation")
    public void testDiscountManipulation() {
        navigateToUrl("/cart");
        
        driver.findElement(By.id("couponCode")).sendKeys("SAVE10");
        driver.findElement(By.id("applyCoupon")).click();
        
        // Try to modify discount percentage via JavaScript
        JavascriptExecutor js = (JavascriptExecutor) driver;
        try {
            js.executeScript("document.querySelector('[name=\"discount\"]').value = '99';");
        } catch (Exception e) {
            // Discount field might not be directly accessible
        }
        
        driver.findElement(By.id("checkoutButton")).click();
        
        SecurityEvent event = SecurityEvent.createHighSeverityEvent(
            "DISCOUNT_MANIPULATION_ATTEMPT",
            "testuser",
            "Discount percentage tampering",
            "Attempted to modify discount value via client-side manipulation"
        );
        eventLogger.logSecurityEvent(event);
    }
}
